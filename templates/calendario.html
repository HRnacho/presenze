<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Presenze - Direzione Lavoro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üìÖ Calendario Presenze - Direzione Lavoro</h1>
                <div class="user-info">
                    <span>üë§ {{ nome_completo }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Esci</a>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="month-selector">
                <button onclick="cambiaMese(-1)" class="btn-nav">‚Üê Mese Prec.</button>
                <h2 id="current-month"></h2>
                <button onclick="cambiaMese(1)" class="btn-nav">Mese Succ. ‚Üí</button>
            </div>
            <button onclick="esportaExcel()" class="btn-export">üì• Esporta Excel</button>
        </div>

        <div class="user-tabs">
            {% for utente in utenti %}
            <button class="user-tab {% if utente.username == current_user %}active{% endif %}" 
                    onclick="selezionaUtente('{{ utente.username }}', '{{ utente.nome }}')"
                    data-username="{{ utente.username }}">
                {{ utente.nome }}
            </button>
            {% endfor %}
        </div>

        <div id="calendario-container"></div>

        <div class="legenda">
            <h3>Legenda:</h3>
            <div class="legenda-items">
                <span class="legenda-item presenza">‚úÖ Presenza (8 ore)</span>
                <span class="legenda-item ferie">üèñÔ∏è Ferie</span>
                <span class="legenda-item rol">üìã ROL</span>
                <span class="legenda-item malattia">üè• Malattia</span>
                <span class="legenda-item permesso">‚è∞ Permesso</span>
                <span class="legenda-item weekend">üîí Weekend</span>
            </div>
        </div>
    </div>

    <div id="modal-presenza" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModal()">&times;</span>
            <h2>Inserisci Presenza</h2>
            <p id="modal-data"></p>
            <p id="modal-utente"></p>
            
            <div class="form-group">
                <label>Tipo di giornata:</label>
                <select id="tipo-presenza" onchange="aggiornaForm()">
                    <option value="presenza">‚úÖ Presenza completa (8 ore lavorate)</option>
                    <option value="ferie">üèñÔ∏è Ferie</option>
                    <option value="rol">üìã ROL</option>
                    <option value="malattia">üè• Malattia</option>
                    <option value="permesso">‚è∞ Permesso retribuito</option>
                </select>
            </div>

            <div id="campi-ore">
                <div class="form-group">
                    <label>Ore lavorate:</label>
                    <input type="number" id="ore-lavorate" min="0" max="8" step="0.5" value="8">
                </div>
                <div class="form-group">
                    <label>Ore assenza/giustificativo:</label>
                    <input type="number" id="ore-assenza" min="0" max="8" step="0.5" value="0">
                </div>
            </div>

            <div class="form-group">
                <label>Note (opzionale):</label>
                <textarea id="note-presenza" rows="3"></textarea>
            </div>

            <div class="modal-buttons">
                <button onclick="salvaPresenza()" class="btn-save">üíæ Salva</button>
                <button onclick="eliminaPresenza()" class="btn-delete" id="btn-elimina" style="display:none;">üóëÔ∏è Elimina</button>
                <button onclick="chiudiModal()" class="btn-cancel">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = {{ year }};
        let currentMonth = {{ month }};
        let selectedUser = '{{ current_user }}';
        let selectedUserName = '{{ nome_completo }}';
        let selectedDate = null;
        let presenzeData = {};

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                           'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];

        function inizializza() {
            aggiornaIntestazione();
            caricaPresenze();
            
            document.getElementById('ore-lavorate').addEventListener('input', function() {
                const oreLavorate = parseFloat(this.value) || 0;
                const oreAssenza = Math.max(0, 8 - oreLavorate);
                document.getElementById('ore-assenza').value = oreAssenza;
            });
            
            document.getElementById('ore-assenza').addEventListener('input', function() {
                const oreAssenza = parseFloat(this.value) || 0;
                const oreLavorate = Math.max(0, 8 - oreAssenza);
                document.getElementById('ore-lavorate').value = oreLavorate;
            });
        }

        function aggiornaIntestazione() {
            document.getElementById('current-month').textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
        }

        function cambiaMese(delta) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            aggiornaIntestazione();
            caricaPresenze();
        }

        function selezionaUtente(username, nome) {
            selectedUser = username;
            selectedUserName = nome;
            document.querySelectorAll('.user-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.username === username) {
                    tab.classList.add('active');
                }
            });
            generaCalendario();
        }

        async function caricaPresenze() {
            try {
                const response = await fetch(`/api/presenze/${currentYear}/${currentMonth}`);
                presenzeData = await response.json();
                generaCalendario();
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nel caricamento delle presenze');
            }
        }

        function generaCalendario() {
            const container = document.getElementById('calendario-container');
            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            let html = '<div class="calendario"><div class="calendario-header">';
            dayNames.forEach(day => {
                html += `<div class="day-name">${day}</div>`;
            });
            html += '</div><div class="calendario-days">';
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="day empty"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth - 1, day);
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                let presenza = null;
                if (presenzeData[selectedUser] && presenzeData[selectedUser][dateStr]) {
                    presenza = presenzeData[selectedUser][dateStr];
                }
                
                let classDay = 'day';
                let icon = '';
                let info = '';
                
                if (isWeekend) {
                    classDay += ' weekend';
                    icon = 'üîí';
                } else if (presenza) {
                    classDay += ' has-presenza';
                    const oreLavorate = presenza.ore_lavorate || 0;
                    const oreAssenza = presenza.ore_assenza || 0;
                    
                    switch (presenza.tipo) {
                        case 'presenza':
                            classDay += ' tipo-presenza';
                            icon = '‚úÖ';
                            info = `${oreLavorate}h`;
                            break;
                        case 'ferie':
                            classDay += ' tipo-ferie';
                            icon = 'üèñÔ∏è';
                            info = `${oreLavorate}h + ${oreAssenza}h F`;
                            break;
                        case 'rol':
                            classDay += ' tipo-rol';
                            icon = 'üìã';
                            info = `${oreLavorate}h + ${oreAssenza}h R`;
                            break;
                        case 'malattia':
                            classDay += ' tipo-malattia';
                            icon = 'üè•';
                            info = `${oreLavorate}h + ${oreAssenza}h M`;
                            break;
                        case 'permesso':
                            classDay += ' tipo-permesso';
                            icon = '‚è∞';
                            info = `${oreLavorate}h + ${oreAssenza}h P`;
                            break;
                    }
                }
                
                const oggi = new Date();
                if (date.toDateString() === oggi.toDateString()) {
                    classDay += ' today';
                }
                
                html += `<div class="${classDay}" onclick="apriModal('${dateStr}', ${isWeekend})">
                            <div class="day-number">${day}</div>
                            <div class="day-icon">${icon}</div>
                            <div class="day-info">${info}</div>
                         </div>`;
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function apriModal(dateStr, isWeekend) {
            if (isWeekend) {
                alert('Non puoi inserire presenze nel weekend');
                return;
            }
            
            selectedDate = dateStr;
            const date = new Date(dateStr + 'T00:00:00');
            const dayName = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'][date.getDay()];
            
            document.getElementById('modal-data').textContent = `üìÖ ${dayName} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            document.getElementById('modal-utente').textContent = `üë§ ${selectedUserName}`;
            
            const presenza = presenzeData[selectedUser]?.[dateStr];
            if (presenza) {
                document.getElementById('tipo-presenza').value = presenza.tipo;
                document.getElementById('ore-lavorate').value = presenza.ore_lavorate || 0;
                document.getElementById('ore-assenza').value = presenza.ore_assenza || 0;
                document.getElementById('note-presenza').value = presenza.note || '';
                document.getElementById('btn-elimina').style.display = 'inline-block';
            } else {
                document.getElementById('tipo-presenza').value = 'presenza';
                document.getElementById('ore-lavorate').value = 8;
                document.getElementById('ore-assenza').value = 0;
                document.getElementById('note-presenza').value = '';
                document.getElementById('btn-elimina').style.display = 'none';
            }
            
            aggiornaForm();
            document.getElementById('modal-presenza').style.display = 'block';
        }

        function chiudiModal() {
            document.getElementById('modal-presenza').style.display = 'none';
        }

        function aggiornaForm() {
            const tipo = document.getElementById('tipo-presenza').value;
            
            if (tipo === 'presenza') {
                document.getElementById('ore-lavorate').value = 8;
                document.getElementById('ore-assenza').value = 0;
            } else {
                const oreLavorate = parseFloat(document.getElementById('ore-lavorate').value) || 0;
                const oreAssenza = parseFloat(document.getElementById('ore-assenza').value) || 0;
                
                if (oreLavorate === 8 && oreAssenza === 0) {
                    document.getElementById('ore-lavorate').value = 0;
                    document.getElementById('ore-assenza').value = 8;
                }
            }
        }

        async function salvaPresenza() {
            const tipo = document.getElementById('tipo-presenza').value;
            let ore_lavorate = parseFloat(document.getElementById('ore-lavorate').value) || 0;
            let ore_assenza = parseFloat(document.getElementById('ore-assenza').value) || 0;
            
            if (ore_lavorate + ore_assenza !== 8) {
                alert('La somma delle ore lavorate e assenza deve essere 8');
                return;
            }
            
            const data = {
                username: selectedUser,
                date: selectedDate,
                tipo: tipo,
                ore_lavorate: ore_lavorate,
                ore_assenza: ore_assenza,
                note: document.getElementById('note-presenza').value
            };
            
            try {
                const response = await fetch('/api/presenza', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    chiudiModal();
                    caricaPresenze();
                } else {
                    alert('Errore nel salvataggio: ' + result.error);
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nel salvataggio della presenza');
            }
        }

        async function eliminaPresenza() {
            if (!confirm('Sei sicuro di voler eliminare questa presenza?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/elimina_presenza', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: selectedUser,
                        date: selectedDate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    chiudiModal();
                    caricaPresenze();
                } else {
                    alert('Errore nell\'eliminazione: ' + result.error);
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nell\'eliminazione della presenza');
            }
        }

        function esportaExcel() {
            window.location.href = `/esporta/${currentYear}/${currentMonth}`;
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal-presenza');
            if (event.target === modal) {
                chiudiModal();
            }
        }

        window.onload = inizializza;
    </script>
</body>
</html>
